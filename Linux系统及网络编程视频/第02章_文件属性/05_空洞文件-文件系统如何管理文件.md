# 8. 空洞文件

## 8.1 什么是空洞文件 

在一般文件的情况下，对于普通文件来说，`文件数据的理论大小 == 在块设备上实际占用的空间大小`

但是空洞文件却不是这样的，对于空洞文件来说，`文件数据的理论大小 > 在块设备上实际占用的空间大小`

## 8.2 空洞文件的意义

### 8.2.1 打个比方	

我承诺给你一亩地，但是你又不是马上就要用满这一亩地，是一点一点来占用的，如果我现在一下子就把一亩地全部给你，但是你要花费很久时间才会把地全用上，在你占满之前，一直有相当部分的空间被闲置不用，显然非常浪费空间资源。

解决办法是，我先承诺说给你一亩地，但是这一亩地先不全部给你，你搬一部分东西过来时，我给你一部分空间，按照这样的方式，直到把1亩地的空间全部给你，在你没有用满一亩地之前，其它的空间我就可以用作它用。

### 8.2.2 迅雷等下载文件

比如下载一个1M大小的文件，文件肯定是要花费相当长的时间才能下载完成，如果我直接就开辟一个实际占用1M空间的普通文件来放数据的话，在实际下载完数据之前，未装满数据的空间都被闲置，会很浪费空间，怎么办呢？


解决办法就是开辟一个1M大小的空洞文件，空洞文件的理论大小是1M，但是并没有在块设备上实际给你分配1M的物理空间，而是在下载过程中，每下载一部分数据，再实际开辟一部分空间给你，直到整个文件下完位置。

## 8.3 在Linux下如何制作空洞文件

### 8.3.1 truncate、ftrucate制作

`文件截短长度 > 文件长度时，多余的部分就是空洞`。
代码演示：	

```c
truncate("./file.txt", 大于文件长度的值);
ftruncate(fd, 大于文件长度的值);
```

+ `du命令`：查看文件在块设备上，`实际占用的物理空间`,空洞部分不会统计在内
+ `ls`：查看到的只是文件的`理论大小`，但是空洞部分并不占用实际物理存储空间

### 8.3.2 使用lseek制作

将文件读写位置调整到文件尾部之后，然后写点数据，中间空出的部分就是空洞。
代码演示：

```c
lseek(fd, 80, SEEK_SET); // 往后移动80位
write(fd, "hello", 5); // 随便写入点东西，前面的80个空洞就生效了
```


# 9. 文件系统是如何管理文件的								

有关文件系统，我们在《计算机体系结构》软件篇4-操作系统时，有非常详细讲解，想详细了解的同学请看这部分课程内容，我们这里只对文件系统做最基本的介绍。

## 9.1 文件系统是什么

文件系统就是一个软件代码，属于OS的一部分。

## 9.2 文件系统管理文件的逻辑结构——树形结构	

文件系统使用树形结构来管理文件的，凡是涉及管理的，都是以树形结构来管理的，比如班级学生组织结构，政府、公司的人员组织结构，都是以树形结构来管理的

对于文件系统来说，目录是非常重要的文件组织节点。

树形结构是以直观的图形方式来展示的，但是文件系统是软件代码来实现的，所以树形管理结构，肯定是以程序代码的形式来构建的。

## 9.3 文件在块设备上是如何存储的

文件在块设备上存储时，磁盘大致被分为三部分：

![文件在块设备上存储](https://i.loli.net/2019/03/29/5c9d98911402a.jpg)


### （1）超级区

> 负责“块设备”空间的分配和回收。

### （2）inode节点区

+ 1）被划分为了一个个相连的，空间大小相同的inode节点空间。

+ 2）每个节点空间被用于存放某个文件的属性信息，每个节点空间大小是固定的
  比如一般的是512字节，512够用吗？
  够，因为文件属性并没有多少数据量。

+ 3）每个节点都有一个节点编号，通过节点编号就可以索引找到inode节点空间 
  使用stat读取文件属性时，struct stat结构体中的st_dev成员，就是用来存储inode节点编号的。

### （3）数据区
数据区专门用于存放文件的数据。

当然我们前面就说过，不是所有的文件都有数据，只有普通文件、目录、链接文件有数据，其它的文件只有属性，没有数据。

存储数据时，实际上并不是数据有多少个字节，就分配对应多少的字节空间给你，为了便于物理空间高效管理，往往都是按块分配空间的，一块往往为4k字节(`4*1024`)

文件中的数据小于一块时，还是给你分配一块，当数据超过一块时，会给你再分配一块，当这一块又满了时，再给你分配一块。

这就好比你去酒店住房时，人家也是按整块空间给你分配的，这个房间满了，人家另外再开一个房间给你。但是人家开的肯定整块的房间，人家不可能半个半个出租，这样不便于管理，道理其实都是一样的。

不同的数据块之间不一定是连续的，块之间使用地址进行相互链接，也即是说每一块都有存放前后块的地址，通过地址就可以找到前后块空间。

+ 1）普通文件
  + （a）如果是文本文件，数据就是文字编码
  + （b）如果是纯二进制文件，数据就是机器指令之类

+ 2）目录文件
  + （a）目录文件的数据量小，所以一般就只有一块数据
  + （b）目录文件里面放的内容，并不是目录所包含文件的数据，放的只是所包含文件的基本信息，其中两个信息最重要
     +  文件名
     +  文件的inode节点号
    这个两个有什么有，后面会详细介绍。

+ 3）链接文件
      存放的数据很简单，就是所指向文件的文件名。


## 9.4 文件系统是如何通过“文件路径名”索引找到文件的

> 索引查找的过程，肯定是通过代码来实现的。

+ 1）索引找到普通文件
    比如：  
  + （a）`fd = open("/new/xxx.txt", O_RDWR);`
    文件系统如何利用/new/xxx.txt，找到xxx.txt文件的？图：  
    找到数据存放空间的起始地址后，read、write调用驱动读写数据时，“块设备驱动程序”通过这个地址，就能够实现数据的读写  

  + （b）`stat("/new/xxx.txt", ...);`  
    这个函数获取文件属性时，也是按照相同的原理来索引的，找到文件的inode节点空间后，就可以将inode节点中的文件属性读取出来。图：

+ 2）索引找到目录文件
   + （a）cd /new/，如何进入new目录的
   + （b）在/目录下，cd . 是怎么回事？
   + （c）在new目录下，cd . 和cd .. 各自是怎么回事？图：
